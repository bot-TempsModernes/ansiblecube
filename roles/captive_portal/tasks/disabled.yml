--- 
- name: Cleaning captive portal specific rules
  command: "{{item}}"   
  with_items:
    - /sbin/iptables -t nat -D PREROUTING -p tcp -m tcp ! -s "{{ hotspot_ip }}" ! -d "{{ hotspot_ip }}" --dport 80 -j CAPTIVE_HTTP
    - /sbin/iptables -t nat -D PREROUTING -p tcp -m tcp ! -s "{{ hotspot_ip }}" ! -d "{{ hotspot_ip }}" --dport 443 -j CAPTIVE_HTTPS
    - /sbin/iptables -t nat -F CAPTIVE_HTTP
    - /sbin/iptables -t nat -F CAPTIVE_HTTPS
    - /sbin/iptables -t nat -F CAPTIVE_PASSLIST
    - /sbin/iptables -t nat -X CAPTIVE_HTTP
    - /sbin/iptables -t nat -X CAPTIVE_HTTPS
    - /sbin/iptables -t nat -X CAPTIVE_PASSLIST
  tags: ['custom', 'update']

- name: Overwrite /etc/iptables.rules to include new rules set
  shell: /sbin/iptables-save > /etc/iptables.rules
  tags: ['custom', 'update']

- name: Disabling systemd service clean-up.service
  service: enabled=no name=clean-up
  tags: ['custom', 'update']

- name: Remove cron entry to clean iptables rules
  cron:
    name: "Clear dead connections from CAPTIVE_PASSLIST"
    minute: "*/5"
    job: "/usr/local/bin/clean_iptables.sh"
    state: absent
  tags: ['custom', 'update']

- name: Setting default dnsmasq config file
  command: sed -i 's/^DNSMASQ_OPTS=.*/DNSMASQ_OPTS="--conf-file=\/etc\/dnsmasq.conf"/g' /etc/default/dnsmasq
  notify: restart dnsmasq

- name: Remove unneeded files
  file: name={{item}} state=absent
  with_items:
    - /var/www/captiveportal/cap.py
    - /var/www/captiveportal
    - /etc/nginx/sites-enabled/captiveportal
    - /etc/nginx/sites-available/captiveportal
    - /etc/nginx/sites-enabled/redirect
    - /etc/nginx/sites-available/redirect
    - /etc/uwsgi/apps-enabled/captive.ini
    - /etc/uwsgi/apps-available/captive.ini
    - /etc/systemd/system/clean-up.service
    - /usr/local/bin/clean-up-dnsmasq.sh
    - /etc/NetworkManager/dispatcher.d/03dnsmasq
    - /usr/local/bin/clean_iptables.sh
  notify: 
    - restart nginx
    - restart uwsgi

