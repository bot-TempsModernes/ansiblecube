---
- name: Create storage dir for ideascube
  file: path=/media/hdd/ideascube/storage/main state=directory owner={{ username }} group={{ username }}
  register: ideascube_installed

- name: Ideascube collectstatic
  become: yes
  become_user: ideascube
  shell: ideascube collectstatic --noinput
  when: ideascube_installed.changed

- name: Ideascube migrate
  become: yes
  become_user: ideascube
  shell: ideascube migrate
  notify: restart uwsgi
  when: ideascube_installed.changed

- name: Download backup
  get_url: url={{filer_bsf}}/billetBlog.tar.gz dest=/tmp/kb_bsfcampus_cmr-0.4.0-201511031142.tar.gz 
  when: ideascube_installed.changed

- name: Import backup 
  become: yes
  become_user: ideascube
  shell: ideascube backup restore /tmp/kb_bsfcampus_cmr-0.4.0-201511031142.tar.gz 
  when: ideascube_installed.changed

- name: Download CSV to import
  get_url: url={{filer_bsf}}/KB_Liste_contenus_bsf_campus.csv dest=/media/hdd/IdeasServerContent/videos/KB_Liste_contenus_bsf_campus.csv
  when: ideascube_installed.changed

- name: Download new videos
  get_url: url={{filer_bsf}}/videosIdeascube.zip dest=/tmp/videosIdeascube.zip
  when: ideascube_installed.changed

- name: unarchive videos
  unarchive: src=/tmp/videosIdeascube.zip dest=/media/hdd/IdeasServerContent/videos/ copy=no
  when: ideascube_installed.changed

- name: Import data 
  become: yes
  become_user: ideascube
  shell: ideascube import_medias /media/hdd/IdeasServerContent/videos/KB_Liste_contenus_bsf_campus.csv
  when: ideascube_installed.changed

- tasks:
  include: ../../../post_tasks.yml task=updateIdeascube version={{ version }}
  when: ideascube_installed.changed