#!/bin/bash

IF=$1
STATUS=$2
PROC=`pgrep ansible-pull`

if [[ "$IF" == "eth0" || "$IF" == "wlan1" ]] && [ -z "$PROC"  ]
then
    case "$STATUS" in
        up)
			/usr/local/bin/ansible-pull {% if ansible_default_ipv4.gateway != bsf_gateway %}-o{% endif %} -s 120 -C oneUpdateFile -d /var/lib/ansible/local -i hosts -U https://github.com/ideascube/ansiblecube.git main.yml --tags "update" >> /var/log/ansible-pull.log 2>&1
        ;;
        *)
        ;;
    esac

    status=$(tail -2 /var/log/ansible-pull.log)
    device_hostname=$(hostname)

	if [[ $status == *"failed=1"* ]]
	then
	        wget http://report.bsf-intranet.org/device=$device_hostname/ansiblepull=fail
	else
	        wget http://report.bsf-intranet.org/device=$device_hostname/ansiblepull=success
	fi
fi
