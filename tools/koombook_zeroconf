#!/bin/bash

# This script has to be drop in /etc/NetworkManager/dispatcher.d/ with chmod 755
# It works along the KoomBook image generated by compilBook
# The purpose of this script is to automate the configuration of a brand new
# assembled KoomBook.
# It will detect the main external HDD /dev/sda and create a new partition on ext4 format.
# Mount the newly partition and move the ideascube data folder to the external HDD. 
# The last operation will give a new name to the device

koombook_name="KoomBook"

function die() {
        echo "$1"
        exit 1
}

if [[ -b /dev/sda && ! -b /dev/sda1 ]]; then

    # TO ENABLE ONLY ON PURPOSE : Format SSD, in case of any issue, report it !
    parted /dev/sda mklabel msdos mkpart primary ext4 0% 100% -s || die "Paritioning issue"
    mkfs.ext4 /dev/sda1 || die "/dev/sda1 can not be formated"

    # mount partition
    mount /dev/sda1 /media/hdd/ || die "Unable to mount partition"

    # Write to fstab
    echo "/dev/sda1 /media/hdd/ ext4 noatime,nofail 0 0" >> /etc/fstab

    # Move ideascube files to the external HDD
    mv /var/cache/ideascube /media/hdd/ideascube_cache
    mv /var/ideascube /media/hdd/
    ln -s /media/hdd/ideascube_cache /var/cache/ideascube
    ln -s /media/hdd/ideascube /var/ideascube

    # Set permissions back to ideascube user
    chown -R ideascube:ideascube /media/hdd/

    # Set permissions back to samba user
    mkdir /media/hdd/samba_share
    chown -R nobody:nogroup /media/hdd/samba_share
    chmod -R 777 /media/hdd/samba_share
    ln -s /media/hdd/samba_share /srv/

    # Make sure udev rules are deleted for wifi usb dongle
    rm -f /etc/udev/rules.d/70-persistent-net.rules

    #Â Disable script 
    chmod -x $0

    # Rename KoomBook
    /var/lib/ansible/local/buildMyCube.sh -n "$koombook_name" -a rename

    reboot

# If partition /dev/sda1 exist, something might went wrong on the last setup.
# We assume the KoomBook is not in production yet, so we delete /dev/sda1 and 
# reboot. The script will fall in first test case and a new partition will be created
else
        # Delete parition
        parted /dev/sda rm 1
  
        reboot
fi
